<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
		<link href="/stylesheets/normalize.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
		<script src="/javascripts/all.js" type="text/javascript"></script>
		<title>Koen.pt | Using Nginx as SSL proxy for name based VirtualHosts in Apache</title>
	</head>
	<body class="blog blog_2012 blog_2012_10 blog_2012_10_04 blog_2012_10_04_using-nginx-as-reverse-proxy-for-name-based-virtualhosts-over-ssl blog_2012_10_04_using-nginx-as-reverse-proxy-for-name-based-virtualhosts-over-ssl_index">
		<div class="container">
			<div id="main" role="main">
				<h1><a href="/">Koen.pt</a></h1>
				<h2>Using Nginx as SSL proxy for name based VirtualHosts in Apache</h2>
				<p>At <a href="http://www.fetch.nl">the company</a> where I work we develop <a href="https://www.facebook.com/Mad.Men.NL?sk=app_168774736517112">all</a> <a href="https://www.facebook.com/Teva/app_273697399381481">kinds</a> <a href="https://www.facebook.com/nederlandsespoorwegen/app_458845137479729">of</a> Facebook applications. And for them to properly work on Facebook, they need to be available over HTTPS. </p>

<p>And because registering and installing a new certificate for each and every new app we create is a real pain in the ass, we registered a wildcard certificate and are hosting all the apps on subdomains.</p>

<p>That worked well, but we still had to request a new IP address for every app, because the lack of <a href="http://en.wikipedia.org/wiki/Server_Name_Indication">SNI</a> in all versions of Internet Explorer on Windows XP. </p>

<p></p>

<p>Now it happens to be that I just recently started to use <a href="http://nginx.org/">Nginx</a> as primary HTTP software on most of the servers I maintain. And using the great proxy functionality of Nginx I managed to setup a server with Nginx as frontend and Apache as backend, where Nginx handles the SSL requests (listening on port 443) for the wildcard domain, and proxies the requests with the correct –requested– hostname to Apache (listening on port 80) so it can use SNI to determine which content to show. </p>

<p>Now the problem arose that links generated by frameworks running under Apache do not know they are requested over SSL, so they would still begin with <code>http://</code> instead of <code>https://</code>, because Apache doesn&#39;t tell them to. </p>

<p>There <a href="https://github.com/gnif/mod_rpaf">mod_rpaf</a> (reverse proxy add forward) comes into place. This module can set Apache&#39;s <code>REMOTE_ADDR</code>, <code>HTTPS</code> and <code>HTTP_PORT</code> –which are generally used to determine if a site is running over SSL– to the values provided by Nginx.</p>

<p><strong>See my configuration below.</strong></p>

<p>Nginx server block:</p>
<pre class="highlight nginx"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div><div class="lineno">6</div><div class="lineno">7</div><div class="lineno">8</div><div class="lineno">9</div><div class="lineno">10</div><div class="lineno">11</div><div class="lineno">12</div><div class="lineno">13</div><div class="lineno">14</div><div class="lineno">15</div><div class="lineno">16</div><div class="lineno">17</div><div class="lineno">18</div><div class="lineno">19</div><div class="lineno">20</div></td><td class="code"><span class="k">server</span> <span class="p">{</span>
  <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>
  <span class="kn">server_name</span> <span class="p">~</span><span class="sr">^(www\.)?(?&lt;domain&gt;.+)$;</span>
  <span class="c1"># It's possible to configure Nginx to serve static files directly, 
</span>  <span class="c1"># and bypassing Apache but I won't describe that here.
</span>  <span class="s">root</span> <span class="n">/var/apps/</span><span class="nv">$domain</span><span class="n">/current/public</span><span class="p">;</span>

  <span class="kn">ssl_certificate</span> <span class="n">/etc/ssl/certs/cmpgns/STAR_cmpgns_nl.crt</span><span class="p">;</span>
  <span class="kn">ssl_certificate_key</span> <span class="n">/etc/ssl/private/STAR_cmpgns_nl.key</span><span class="p">;</span>

  <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="c1"># Apache is listening here
</span>    <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:80</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    <span class="c1"># Set HTTPS flag for mod_rpaf
</span>    <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-HTTPS</span> <span class="no">on</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</td></tr></tbody></table></pre>
<p>Apache VirtualHost:</p>
<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div><div class="lineno">6</div><div class="lineno">7</div><div class="lineno">8</div><div class="lineno">9</div></td><td class="code">&lt;VirtualHost 127.0.0.1:80&gt;
  ServerName some-subdomain.cmpgns.nl
  DocumentRoot &quot;/var/apps/some-subdomain.cmpgns.nl/current/public&quot;

  RewriteEngine on
  &lt;Directory &quot;/var/apps/some-subdomain.cmpgns.nl/current/public&quot;&gt;
    Allow from all
  &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</td></tr></tbody></table></pre>
<p>Apache RPAF configuration:</p>
<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div><div class="lineno">6</div></td><td class="code">RPAF_Enable       On
RPAF_ProxyIPs     127.0.0.1
RPAF_Header       X-Real-IP
RPAF_SetHostName  On
RPAF_SetHTTPS     On
RPAF_SetPort      On
</td></tr></tbody></table></pre>
			</div>
			<aside>
				<h2>Recent Articles</h2>
				<ol>
					
					<li><a href="/blog/2013/01/17/ssh-shell-wrapper-to-provide-custom-prompt/">SSH shell wrapper to provide custom prompt</a> <span>Jan 17</span></li>
					
					<li><a href="/blog/2012/10/04/using-nginx-as-reverse-proxy-for-name-based-virtualhosts-over-ssl/">Using Nginx as SSL proxy for name based VirtualHosts in Apache</a> <span>Oct  4</span></li>
					
				</ol>

				<h2>Tags</h2>
				<ol>
					
					<li><a href="/blog/tags/apache/">Apache</a> (1)</a></li>
					
					<li><a href="/blog/tags/nginx/">Nginx</a> (1)</a></li>
					
					<li><a href="/blog/tags/server/">Server</a> (2)</a></li>
					
					<li><a href="/blog/tags/guide/">Guide</a> (2)</a></li>
					
					<li><a href="/blog/tags/facebook/">Facebook</a> (1)</a></li>
					
					<li><a href="/blog/tags/ssl/">SSL</a> (1)</a></li>
					
					<li><a href="/blog/tags/ssh/">SSH</a> (1)</a></li>
					
				</ol>

				<h2>By Year</h2>
				<ol>
					
					<li><a href="/blog/2013/">2013</a> (1)</a></li>
					
					<li><a href="/blog/2012/">2012</a> (1)</a></li>
					
				</ol>
			</aside>
		</div>
		<script type="text/javascript">
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-770386-7']);
			_gaq.push(['_trackPageview']);
		
			(function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();
		</script>
	</body>
</html>
